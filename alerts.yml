groups:
  - name: database_alerts
    interval: 30s
    rules:
      # PostgreSQL Alerts
      - alert: PostgreSQLDown
        expr: up{job="postgres-exporter"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "PostgreSQL cluster is down"
          description: "PostgreSQL cluster has been down for more than 1 minute."

      - alert: PostgreSQLHighConnections
        expr: pg_stat_activity_count > 800
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High PostgreSQL connection count"
          description: "PostgreSQL has {{ $value }} active connections, which is above the threshold of 800."

      - alert: PostgreSQLReplicationLag
        expr: pg_stat_replication_lag > 1048576
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "PostgreSQL replication lag is high"
          description: "PostgreSQL replication lag is {{ $value }} bytes, which is above the threshold."

      # MongoDB Alerts
      - alert: MongoDBDown
        expr: up{job="mongodb-exporter"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "MongoDB cluster is down"
          description: "MongoDB cluster has been down for more than 1 minute."

      - alert: MongoDBHighConnections
        expr: mongodb_connections > 500
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High MongoDB connection count"
          description: "MongoDB has {{ $value }} active connections, which is above the threshold of 500."

      - alert: MongoDBReplicationLag
        expr: mongodb_replset_member_optime_date_difference > 30
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "MongoDB replication lag is high"
          description: "MongoDB replication lag is {{ $value }} seconds, which is above the threshold."

      # Redis Alerts
      - alert: RedisDown
        expr: up{job="redis-exporter"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Redis cluster is down"
          description: "Redis cluster has been down for more than 1 minute."

      - alert: RedisHighMemoryUsage
        expr: redis_memory_used_bytes / redis_memory_max_bytes > 0.8
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High Redis memory usage"
          description: "Redis memory usage is {{ $value | printf \"%.2f\" }}%, which is above the threshold of 80%."

      - alert: RedisHighConnections
        expr: redis_connected_clients > 1000
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High Redis connection count"
          description: "Redis has {{ $value }} connected clients, which is above the threshold of 1000."

      # Backup Alerts
      - alert: BackupFailed
        expr: increase(db_backup_last_success_timestamp_seconds[1h]) == 0
        for: 2h
        labels:
          severity: critical
        annotations:
          summary: "Database backup has failed"
          description: "No successful database backup has been performed in the last 2 hours."

      # General Database Alerts
      - alert: DatabaseResponseTimeHigh
        expr: |
          (
            increase(http_request_duration_seconds_sum{job=~"postgres-exporter|mongodb-exporter|redis-exporter"}[5m]) /
            increase(http_request_duration_seconds_count{job=~"postgres-exporter|mongodb-exporter|redis-exporter"}[5m])
          ) > 1
        for: 3m
        labels:
          severity: warning
        annotations:
          summary: "Database response time is high"
          description: "Average database response time is {{ $value }} seconds, which is above the threshold of 1 second."